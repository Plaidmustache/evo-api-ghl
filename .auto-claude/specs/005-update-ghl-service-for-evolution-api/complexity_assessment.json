{
  "complexity": "standard",
  "workflow_type": "refactor",
  "confidence": 0.85,
  "reasoning": "This is a well-defined refactor replacing GREEN-API SDK with Evolution API. While it touches multiple files (service, transformer, module, possibly schema), it follows a clear pattern replacement. The Evolution API client dependency may need to be created first, adding some prerequisite work.",

  "analysis": {
    "scope": {
      "estimated_files": 5,
      "estimated_services": 1,
      "is_cross_cutting": false,
      "notes": "Primary files: ghl.service.ts (812 lines), ghl.transformer.ts, ghl.module.ts. Database schema and types may also need updates. All within same NestJS service."
    },
    "integrations": {
      "external_services": ["Evolution API"],
      "new_dependencies": [],
      "research_needed": false,
      "notes": "Evolution API is similar to GREEN-API (both Baileys-based). No new external SDK packages - Evolution uses direct REST calls. The EvolutionApiClient should already exist at src/evolution/evolution-api.client based on requirements, but no files found at that location - may be a prerequisite."
    },
    "infrastructure": {
      "docker_changes": false,
      "database_changes": true,
      "config_changes": true,
      "notes": "Database schema needs to change: idInstance (BigInt) → instanceName (String), add evolutionApiUrl and evolutionApiKey fields. New env vars may be needed for Evolution API defaults."
    },
    "knowledge": {
      "patterns_exist": true,
      "research_required": false,
      "unfamiliar_tech": [],
      "notes": "Current codebase has clear patterns for GHL integration. Evolution API follows similar patterns to GREEN-API. The CLAUDE.md documents the webhook format differences clearly."
    },
    "risk": {
      "level": "medium",
      "concerns": [
        "Core WhatsApp integration being replaced",
        "Service extends BaseAdapter from GREEN-API SDK - inheritance needs handling",
        "Database schema migration required for existing instances",
        "Heavy coupling to GREEN-API types in transformer",
        "Evolution API client may not exist yet (prerequisite dependency)"
      ],
      "notes": "The refactor is well-scoped but touches critical message handling path. Existing instances will need migration strategy."
    }
  },

  "recommended_phases": [
    "discovery",
    "requirements",
    "context",
    "spec_writing",
    "planning",
    "validation"
  ],

  "flags": {
    "needs_research": false,
    "needs_self_critique": false,
    "needs_infrastructure_setup": false
  },

  "dependencies": {
    "has_prerequisites": true,
    "prerequisites": [
      "Evolution API client at src/evolution/evolution-api.client.ts",
      "Evolution module for NestJS dependency injection",
      "Updated transformer methods for Evolution format"
    ],
    "notes": "The glob search for src/**/*evolution* returned no files. The task assumes EvolutionApiClient exists but it may need to be created first. Verify prerequisites exist before implementation."
  },

  "validation_recommendations": {
    "risk_level": "medium",
    "skip_validation": false,
    "minimal_mode": false,
    "test_types_required": ["unit", "integration"],
    "security_scan_required": false,
    "staging_deployment_required": false,
    "reasoning": "Core integration refactor requires unit tests for service methods and integration tests for webhook handling. No security scan needed as this is replacing one API with an equivalent one, not adding auth or payment features."
  },

  "implementation_notes": {
    "key_changes": [
      "Remove @green-api/greenapi-integration package imports",
      "Remove BaseAdapter extension from GhlService class",
      "Replace GreenApiLogger with NestJS Logger",
      "Rename createGreenApiInstanceForUser → createEvolutionInstanceForUser",
      "Rename handleGreenApiWebhook → handleEvolutionWebhook",
      "Update Instance lookup from idInstance to instanceName",
      "Update message sending to use EvolutionApiClient methods"
    ],
    "breaking_changes": [
      "Database schema change (idInstance → instanceName)",
      "Webhook endpoint may need different event handling"
    ]
  },

  "created_at": "2025-01-11T00:00:00.000Z"
}
