{
  "feature": "Update GHL Service for Evolution API",
  "workflow_type": "feature",
  "workflow_rationale": "This is a multi-step migration task that introduces Evolution API integration patterns while replacing GREEN-API SDK usage. It involves sequential changes to imports, logging, methods, and module configuration, following established NestJS patterns already present in the codebase.",
  "phases": [
    {
      "id": "phase-1-imports-cleanup",
      "name": "Remove GREEN-API and Setup Evolution Imports",
      "type": "implementation",
      "description": "Remove all GREEN-API SDK imports, remove BaseAdapter extension, add Evolution API client import, and replace GreenApiLogger with NestJS Logger",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Remove GREEN-API package imports and BaseAdapter extension from GhlService",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -r '@green-api/greenapi-integration' src/ghl/ghl.service.ts || echo 'No GREEN-API imports found'",
            "expected": "No GREEN-API imports found"
          },
          "status": "completed",
          "notes": "Successfully removed all GREEN-API package imports (@green-api/greenapi-integration and dist/types), removed BaseAdapter extension from GhlService class, and removed super() call from constructor. Verification passed - no GREEN-API imports remain in ghl.service.ts.",
          "updated_at": "2026-01-11T16:14:32.665731+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Add Evolution API client import and Evolution webhook types",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts",
            "src/ghl/types/evolution-webhook.types.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -E 'EvolutionApiClient|evolution-api' src/ghl/ghl.service.ts && echo 'Evolution imports found'",
            "expected": "Evolution imports found"
          },
          "status": "completed",
          "notes": "Successfully added Evolution API imports to ghl.service.ts: 1) EvolutionApiClient from '../evolution/evolution-api.client', 2) EvolutionWebhook type from './types/evolution-webhook.types'. Verification passed - grep confirms Evolution imports are present.",
          "updated_at": "2026-01-11T16:15:33.901134+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Replace GreenApiLogger with NestJS native Logger throughout service",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -E 'GreenApiLogger|gaLogger' src/ghl/ghl.service.ts || echo 'No GreenApiLogger references'",
            "expected": "No GreenApiLogger references"
          },
          "status": "completed",
          "notes": "Replaced GreenApiLogger with NestJS native Logger. Added Logger import from @nestjs/common, created private readonly logger = new Logger(GhlService.name), and replaced all this.gaLogger references with this.logger. Converted .info() calls to .log() as NestJS Logger doesn't have .info() method.",
          "updated_at": "2026-01-11T16:16:43.876729+00:00"
        }
      ]
    },
    {
      "id": "phase-2-instance-creation",
      "name": "Update Instance Creation Method",
      "type": "implementation",
      "description": "Rename createGreenApiInstanceForUser to createEvolutionInstanceForUser with new signature and Evolution API integration",
      "depends_on": [
        "phase-1-imports-cleanup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Rename and refactor createGreenApiInstanceForUser to createEvolutionInstanceForUser with Evolution API",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep 'createEvolutionInstanceForUser' src/ghl/ghl.service.ts && echo 'Method renamed'",
            "expected": "Method renamed"
          },
          "status": "completed",
          "notes": "Successfully renamed createGreenApiInstanceForUser to createEvolutionInstanceForUser. Updated method signature to accept (ghlUserId, instanceName, evolutionApiUrl, evolutionApiKey, name?). Uses EvolutionApiClient for connection state verification and webhook registration. Maps Evolution state 'open' to 'authorized'. Stores Evolution API credentials in settings JSON for database compatibility. Replaced custom errors with NestJS HttpException. Note: Controller reference to old method name exists but is out of scope for this subtask - will be addressed in integration phase.",
          "updated_at": "2026-01-11T16:20:08.708152+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Remove createGreenApiClient helper method entirely",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep 'createGreenApiClient' src/ghl/ghl.service.ts || echo 'Method removed'",
            "expected": "Method removed"
          },
          "status": "completed",
          "notes": "Removed all createGreenApiClient usages from GhlService. Replaced with direct EvolutionApiClient instantiation in both handlePlatformWebhook and handleWorkflowAction. Evolution API credentials are read from instance.settings. Interactive buttons and reply buttons are converted to text messages (Evolution API doesn't support native buttons). Response message IDs now use sendResponse.key.id format.",
          "updated_at": "2026-01-11T16:23:42.623075+00:00"
        }
      ]
    },
    {
      "id": "phase-3-webhook-handling",
      "name": "Update Webhook Handling Methods",
      "type": "implementation",
      "description": "Rename handleGreenApiWebhook to handleEvolutionWebhook and update for Evolution API format, update handleStateInstanceWebhook",
      "depends_on": [
        "phase-1-imports-cleanup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Rename and refactor handleGreenApiWebhook to handleEvolutionWebhook",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/ghl/types/evolution-webhook.types.ts",
            "src/ghl/ghl.transformer.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep 'handleEvolutionWebhook' src/ghl/ghl.service.ts && echo 'Method renamed'",
            "expected": "Method renamed"
          },
          "status": "completed",
          "notes": "Renamed handleGreenApiWebhook to handleEvolutionWebhook. Created src/ghl/types/evolution-webhook.types.ts with Evolution API webhook types (EvolutionWebhook, EvolutionMessage, etc.). Updated method to handle Evolution webhook format with {event, instance, data} structure. Added helper methods: processEvolutionMessage for processing individual messages, transformEvolutionMessageToGhl for message transformation, and handleConnectionUpdate for connection state changes. Uses instanceName to idInstance hash conversion for database lookups (same approach as createEvolutionInstanceForUser). Replaced IntegrationError/NotFoundError with HttpException from NestJS. Note: handleStateInstanceWebhook method still exists using old GREEN-API types - will be handled in subtask-3-2.",
          "updated_at": "2026-01-11T16:27:52.629639+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Update handleStateInstanceWebhook to handleConnectionUpdate for Evolution events",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/ghl/types/evolution-webhook.types.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -E 'handleConnectionUpdate|connection.update' src/ghl/ghl.service.ts && echo 'Connection handler updated'",
            "expected": "Connection handler updated"
          },
          "status": "completed",
          "notes": "Removed deprecated handleStateInstanceWebhook method that referenced non-existent StateInstanceWebhook type. Connection state updates are now handled by handleConnectionUpdate method for Evolution API CONNECTION_UPDATE events.",
          "updated_at": "2026-01-11T16:29:22.405633+00:00"
        }
      ]
    },
    {
      "id": "phase-4-message-sending",
      "name": "Update Message Sending Methods",
      "type": "implementation",
      "description": "Update handlePlatformWebhook and handleWorkflowAction to use Evolution API client instead of GREEN-API",
      "depends_on": [
        "phase-1-imports-cleanup",
        "phase-2-instance-creation"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Update handlePlatformWebhook to use EvolutionApiClient for sending messages",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts",
            "src/ghl/ghl.transformer.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -E 'evolutionClient\\.(sendText|sendMedia)' src/ghl/ghl.service.ts && echo 'Using Evolution client'",
            "expected": "Using Evolution client"
          },
          "status": "completed",
          "notes": "Updated handlePlatformWebhook to use EvolutionApiClient for sending messages. Created src/evolution/evolution-api.client.ts with EvolutionApiClient class (sendText, sendMedia, getConnectionState, setWebhook methods). Created src/evolution/evolution.module.ts for module exports. Replaced NotFoundError/IntegrationError with HttpException, renamed gaResponse to sendResponse, updated return type to EvolutionSendResponse, fixed formatPhoneNumber dependency with direct regex, fixed SendInteractiveButtons type references. Verification passed - grep confirms evolutionClient.sendText and evolutionClient.sendMedia usage.",
          "updated_at": "2026-01-11T16:33:58.085663+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Update handleWorkflowAction to use EvolutionApiClient for all action types",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.service.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution-api.client.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -E 'greenApiClient' src/ghl/ghl.service.ts || echo 'No greenApiClient references'",
            "expected": "No greenApiClient references"
          },
          "status": "completed",
          "notes": "Verified handleWorkflowAction uses EvolutionApiClient for all action types: (1) message: evolutionClient.sendText(), (2) file: evolutionClient.sendMedia(), (3) interactive-buttons: converted to text via evolutionClient.sendText(), (4) reply-buttons: converted to text via evolutionClient.sendText(). Updated contact source from 'GREEN-API' to 'EVOLUTION-API' for consistency. Verification passed - no greenApiClient references remain.",
          "updated_at": "2026-01-11T16:35:18.560967+00:00"
        }
      ]
    },
    {
      "id": "phase-5-module-update",
      "name": "Update GHL Module Configuration",
      "type": "implementation",
      "description": "Import EvolutionModule in GhlModule to make EvolutionApiClient available for dependency injection",
      "depends_on": [
        "phase-1-imports-cleanup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Import EvolutionModule in ghl.module.ts",
          "service": "main",
          "files_to_modify": [
            "src/ghl/ghl.module.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/evolution/evolution.module.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep 'EvolutionModule' src/ghl/ghl.module.ts && echo 'EvolutionModule imported'",
            "expected": "EvolutionModule imported"
          },
          "status": "pending",
          "notes": "Add import { EvolutionModule } from '../evolution/evolution.module'. Add EvolutionModule to imports array in @Module decorator."
        }
      ]
    },
    {
      "id": "phase-6-integration",
      "name": "Integration Verification",
      "type": "integration",
      "description": "Verify all changes work together and TypeScript compiles without errors",
      "depends_on": [
        "phase-2-instance-creation",
        "phase-3-webhook-handling",
        "phase-4-message-sending",
        "phase-5-module-update"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Verify TypeScript compilation passes with no errors",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm run build",
            "expected": "Build completes without errors"
          },
          "status": "pending",
          "notes": "Run npm run build and verify no TypeScript errors. Fix any type issues."
        },
        {
          "id": "subtask-6-2",
          "description": "Verify complete removal of all GREEN-API references",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -rE 'green-api|GreenApi|greenApi|gaLogger' src/ghl/ghl.service.ts || echo 'All GREEN-API references removed'",
            "expected": "All GREEN-API references removed"
          },
          "status": "pending",
          "notes": "Final cleanup verification - no GREEN-API, GreenApi, greenApi, or gaLogger references should remain"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 11,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-instance-creation",
            "phase-3-webhook-handling",
            "phase-5-module-update"
          ],
          "reason": "All depend only on phase-1, modify different methods/files"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential recommended - single file with interconnected changes and shared dependencies"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 005 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "No GREEN-API imports remain in ghl.service.ts",
      "No GreenApiLogger or gaLogger references remain",
      "All methods use EvolutionApiClient instead of GREEN-API client",
      "TypeScript compilation passes without errors",
      "EvolutionModule properly imported in GhlModule",
      "Instance creation uses Evolution API getConnectionState and setWebhook",
      "Webhook handling parses Evolution format correctly"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Build",
        "command": "npm run build",
        "expected_outcome": "No compilation errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "GREEN-API Removal Check",
        "command": "grep -r '@green-api/greenapi-integration' src/ghl/ || echo 'PASS: No GREEN-API imports'",
        "expected_outcome": "PASS: No GREEN-API imports",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Logger Migration Check",
        "command": "grep -E 'GreenApiLogger|gaLogger' src/ghl/ || echo 'PASS: No GreenApiLogger'",
        "expected_outcome": "PASS: No GreenApiLogger",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Evolution Client Usage Check",
        "command": "grep 'EvolutionApiClient' src/ghl/ghl.service.ts && echo 'PASS: Using Evolution client'",
        "expected_outcome": "PASS: Using Evolution client",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk refactor of core integration service. Verification focuses on complete removal of GREEN-API SDK and successful Evolution API client integration. No external API testing required - focus on code structure verification."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "npm run build"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [],
      "services_to_test": [
        "main"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "code_verification": [
      {
        "check": "No GREEN-API imports",
        "command": "grep -r '@green-api/greenapi-integration' src/ghl/ghl.service.ts",
        "expected": "No matches"
      },
      {
        "check": "No GreenApiLogger",
        "command": "grep -r 'GreenApiLogger' src/ghl/",
        "expected": "No matches"
      },
      {
        "check": "No gaLogger references",
        "command": "grep -r 'gaLogger' src/ghl/",
        "expected": "No matches"
      },
      {
        "check": "TypeScript compilation",
        "command": "npm run build",
        "expected": "No errors"
      },
      {
        "check": "EvolutionModule imported",
        "command": "grep 'EvolutionModule' src/ghl/ghl.module.ts",
        "expected": "Match found"
      },
      {
        "check": "EvolutionApiClient used",
        "command": "grep 'EvolutionApiClient' src/ghl/ghl.service.ts",
        "expected": "Match found"
      }
    ]
  },
  "qa_signoff": null,
  "created_at": "2026-01-11T14:25:59.106Z",
  "updated_at": "2026-01-11T16:13:03.912Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "last_updated": "2026-01-11T16:35:18.560979+00:00"
}