{
  "feature": "Update Controller and Prisma for Evolution API",
  "workflow_type": "feature",
  "workflow_rationale": "This is a feature implementation that introduces new Evolution API integration patterns while removing legacy Green API dependencies. It modifies core data structures, method signatures, and identifier strategies across two files.",
  "phases": [
    {
      "id": "phase-1-prisma",
      "name": "Prisma Service Updates",
      "type": "implementation",
      "description": "Update the Prisma service to remove Green API dependencies and use instanceName for all instance lookups",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Remove StorageProvider interface and Green API imports from Prisma service",
          "service": "main",
          "files_to_modify": ["src/prisma/prisma.service.ts"],
          "files_to_create": [],
          "patterns_from": [],
          "details": {
            "remove_imports": [
              "StorageProvider from @green-api/greenapi-integration",
              "Settings from @green-api/greenapi-integration"
            ],
            "remove_implementation": "Remove 'implements StorageProvider<...>' from class declaration",
            "keep_unchanged": [
              "createUser()",
              "findUser()",
              "updateUser()",
              "getUserWithTokens()",
              "updateUserTokens()"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep -c '@green-api/greenapi-integration' src/prisma/prisma.service.ts || echo '0'",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-2",
          "description": "Update createInstance() method to use new schema fields (instanceName, evolutionApiUrl, evolutionApiKey)",
          "service": "main",
          "files_to_modify": ["src/prisma/prisma.service.ts"],
          "files_to_create": [],
          "patterns_from": ["src/prisma/prisma.service.ts"],
          "details": {
            "old_signature": "createInstance(instanceData: Prisma.InstanceCreateInput): Promise<Instance>",
            "changes": [
              "Remove idInstance BigInt conversion",
              "Use instanceName field for uniqueness check",
              "Use evolutionApiUrl and evolutionApiKey instead of apiTokenInstance",
              "Update field references in create data"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep 'instanceName' src/prisma/prisma.service.ts | wc -l",
            "expected": "Multiple instanceName references"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-3",
          "description": "Update getInstance() to use instanceName string instead of BigInt idInstance",
          "service": "main",
          "files_to_modify": ["src/prisma/prisma.service.ts"],
          "files_to_create": [],
          "patterns_from": ["src/prisma/prisma.service.ts"],
          "details": {
            "old_signature": "getInstance(idInstance: number | bigint): Promise<(Instance & { user: User }) | null>",
            "new_signature": "getInstance(instanceName: string): Promise<(Instance & { user: User }) | null>",
            "changes": [
              "Change parameter from idInstance: number | bigint to instanceName: string",
              "Update where clause to use instanceName",
              "Remove BigInt() conversion"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep 'getInstance(instanceName: string)' src/prisma/prisma.service.ts",
            "expected": "Match found"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-4",
          "description": "Update removeInstance() to use instanceName string instead of BigInt idInstance",
          "service": "main",
          "files_to_modify": ["src/prisma/prisma.service.ts"],
          "files_to_create": [],
          "patterns_from": ["src/prisma/prisma.service.ts"],
          "details": {
            "old_signature": "removeInstance(idInstance: number | bigint): Promise<Instance>",
            "new_signature": "removeInstance(instanceName: string): Promise<Instance>",
            "changes": [
              "Change parameter to instanceName: string",
              "Update where clause to use instanceName",
              "Remove BigInt() conversion"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep 'removeInstance(instanceName: string)' src/prisma/prisma.service.ts",
            "expected": "Match found"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-5",
          "description": "Update updateInstanceSettings(), updateInstanceState(), and updateInstanceName() to use instanceName string",
          "service": "main",
          "files_to_modify": ["src/prisma/prisma.service.ts"],
          "files_to_create": [],
          "patterns_from": ["src/prisma/prisma.service.ts"],
          "details": {
            "methods_to_update": [
              {
                "old": "updateInstanceSettings(idInstance: number | bigint, settings: Settings)",
                "new": "updateInstanceSettings(instanceName: string, settings: Record<string, any>)"
              },
              {
                "old": "updateInstanceState(idInstance: number | bigint, state: InstanceState)",
                "new": "updateInstanceState(instanceName: string, state: InstanceState)"
              },
              {
                "old": "updateInstanceName(idInstance: number | bigint, name: string)",
                "new": "updateInstanceName(instanceName: string, displayName: string)"
              }
            ],
            "changes": [
              "Change all parameters to instanceName: string",
              "Update where clauses to use instanceName",
              "Remove BigInt() conversions",
              "Use Record<string, any> for settings instead of Settings type"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep -E 'updateInstance.*(instanceName: string)' src/prisma/prisma.service.ts | wc -l",
            "expected": "3"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-2-controller",
      "name": "Controller Updates",
      "type": "implementation",
      "description": "Update the GHL controller to use new DTOs, remove Green API dependencies, and use instanceName for lookups",
      "depends_on": ["phase-1-prisma"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Replace GreenApiLogger with NestJS Logger and update imports",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": [],
          "details": {
            "remove_import": "import { GreenApiLogger } from '@green-api/greenapi-integration'",
            "add_import": "Logger already imported from @nestjs/common",
            "update_logger": "Change 'GreenApiLogger.getInstance(GhlController.name)' to 'new Logger(GhlController.name)'"
          },
          "verification": {
            "type": "command",
            "command": "grep -c '@green-api/greenapi-integration' src/ghl/ghl.controller.ts || echo '0'",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Update CreateInstanceDto interface for Evolution API",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": ["src/types.ts"],
          "details": {
            "old_dto": {
              "locationId": "string",
              "instanceId": "string",
              "apiToken": "string",
              "name?": "string"
            },
            "new_dto": {
              "locationId": "string",
              "instanceName": "string",
              "evolutionApiUrl": "string",
              "evolutionApiKey": "string",
              "name?": "string"
            }
          },
          "verification": {
            "type": "command",
            "command": "grep -A5 'interface CreateInstanceDto' src/ghl/ghl.controller.ts | grep instanceName",
            "expected": "instanceName found in DTO"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Update getInstances() method to return instanceName and evolutionApiUrl",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": ["src/ghl/ghl.controller.ts"],
          "details": {
            "changes": [
              "Return instanceName instead of idInstance.toString()",
              "Return evolutionApiUrl in response",
              "Update name fallback to use instanceName",
              "State values pass through unchanged (open/close/connecting)"
            ],
            "old_response_mapping": "{ id: instance.idInstance.toString(), name: instance.name || `Instance ${instance.idInstance}`, ... }",
            "new_response_mapping": "{ id: instance.instanceName, name: instance.name || `Instance ${instance.instanceName}`, evolutionApiUrl: instance.evolutionApiUrl, ... }"
          },
          "verification": {
            "type": "command",
            "command": "grep 'instanceName' src/ghl/ghl.controller.ts | wc -l",
            "expected": "Multiple occurrences"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-4",
          "description": "Update createInstance() method to use new DTO and service method",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": ["src/ghl/ghl.controller.ts"],
          "details": {
            "changes": [
              "Call ghlService.createEvolutionInstanceForUser() with new parameters",
              "Remove BigInt() conversion of instanceId",
              "Use dto.instanceName, dto.evolutionApiUrl, dto.evolutionApiKey",
              "Update response to return instanceName instead of idInstance",
              "Update error messages from 'GREEN-API' to 'Evolution API'"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep 'createEvolutionInstanceForUser' src/ghl/ghl.controller.ts",
            "expected": "Match found"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-5",
          "description": "Update deleteInstance() to use instanceName parameter",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": ["src/ghl/ghl.controller.ts"],
          "details": {
            "old_route": "@Delete(':instanceId')",
            "new_route": "@Delete(':instanceName')",
            "changes": [
              "Update route parameter from instanceId to instanceName",
              "Update Param decorator from 'instanceId' to 'instanceName'",
              "Remove BigInt() conversion in getInstance() call",
              "Remove BigInt() conversion in removeInstance() call",
              "Pass instanceName directly as string"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep '@Delete' src/ghl/ghl.controller.ts",
            "expected": "@Delete(':instanceName')"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-6",
          "description": "Update updateInstance() to use instanceName parameter",
          "service": "main",
          "files_to_modify": ["src/ghl/ghl.controller.ts"],
          "files_to_create": [],
          "patterns_from": ["src/ghl/ghl.controller.ts"],
          "details": {
            "old_route": "@Patch(':instanceId')",
            "new_route": "@Patch(':instanceName')",
            "changes": [
              "Update route parameter from instanceId to instanceName",
              "Update Param decorator from 'instanceId' to 'instanceName'",
              "Remove BigInt() conversion in getInstance() call",
              "Remove BigInt() conversion in updateInstanceName() call",
              "Update response mapping to use instanceName",
              "Add authorization check (compare instance.userId with req.locationId)"
            ]
          },
          "verification": {
            "type": "command",
            "command": "grep '@Patch' src/ghl/ghl.controller.ts",
            "expected": "@Patch(':instanceName')"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-verification",
      "name": "Verification",
      "type": "integration",
      "description": "Verify TypeScript compilation and that no Green API dependencies remain",
      "depends_on": ["phase-2-controller"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Verify TypeScript compilation",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npx tsc --noEmit 2>&1 | head -20",
            "expected": "No errors or only unrelated warnings"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Verify no Green API imports remain in modified files",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -l '@green-api/greenapi-integration' src/ghl/ghl.controller.ts src/prisma/prisma.service.ts 2>/dev/null | wc -l",
            "expected": "0"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Verify no BigInt conversions remain in instance methods",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -E 'BigInt\\(.*instance' src/ghl/ghl.controller.ts src/prisma/prisma.service.ts 2>/dev/null | wc -l",
            "expected": "0"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 3,
    "total_subtasks": 14,
    "services_involved": ["main"],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution required - controller depends on prisma service updates"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 007 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "TypeScript compiles without errors",
      "No imports from @green-api/greenapi-integration in modified files",
      "No BigInt conversions in instance-related methods",
      "All instance methods use instanceName: string parameter",
      "CreateInstanceDto uses instanceName, evolutionApiUrl, evolutionApiKey",
      "Controller responses include instanceName instead of idInstance"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Compilation",
        "command": "npx tsc --noEmit",
        "expected_outcome": "No errors",
        "type": "build",
        "required": true,
        "blocking": true
      },
      {
        "name": "Green API Import Check",
        "command": "grep -r '@green-api/greenapi-integration' src/ghl/ghl.controller.ts src/prisma/prisma.service.ts",
        "expected_outcome": "No matches (exit code 1)",
        "type": "lint",
        "required": true,
        "blocking": true
      },
      {
        "name": "BigInt Conversion Check",
        "command": "grep -E 'BigInt\\(' src/ghl/ghl.controller.ts src/prisma/prisma.service.ts | grep -v '// BigInt' | wc -l",
        "expected_outcome": "0 (no BigInt conversions in instance methods)",
        "type": "lint",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk change that affects method signatures and API contracts. Verification focuses on compilation success and absence of old patterns."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["npx jest --passWithNoTests"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["npx jest --testPathPattern=integration --passWithNoTests"],
      "services_to_test": ["main"]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": true,
      "checks": ["prisma-generate", "schema-valid"]
    }
  },
  "qa_signoff": null,
  "created_at": "2026-01-11T14:27:12.159Z",
  "updated_at": "2026-01-11T19:00:00.000Z",
  "status": "planned"
}
