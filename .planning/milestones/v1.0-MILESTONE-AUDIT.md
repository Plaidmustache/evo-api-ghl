---
milestone: v1
audited: 2025-01-18T02:00:00Z
status: passed
scores:
  requirements: 16/16
  phases: 3/3
  integration: 8/8
  flows: 3/3
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 01-lid-handling
    items: []
  - phase: 02-database-schema
    items:
      - "cleanupOldSentMessages() defined but not scheduled - needs cron job post-v1"
  - phase: 03-status-webhook-flow
    items: []
orphaned_exports:
  - name: formatJid
    location: src/ghl/jid.utils.ts
    reason: "Utility for creating JIDs - available for future use"
    impact: LOW
  - name: findSentMessageByGhlId
    location: src/prisma/prisma.service.ts:191
    reason: "Reverse lookup utility - available for debugging/admin"
    impact: LOW
  - name: cleanupOldSentMessages
    location: src/prisma/prisma.service.ts:201
    reason: "Cleanup utility needing cron job - documented as operational task"
    impact: LOW
---

# v1 Milestone Audit: evo-api-ghl Bug Fixes

**Milestone:** v1 Bug Fixes
**Audited:** 2025-01-18
**Status:** PASSED
**Core Value:** Every patient message reaches the practice, and practitioners see real delivery/read status

## Executive Summary

All v1 requirements are satisfied. The two critical bugs have been fixed:

1. **@lid Handling** - Messages from Android WhatsApp users (30-40% of users) now correctly extract phone numbers and reach GHL
2. **Real Status Tracking** - GHL shows actual delivered/read status from WhatsApp instead of fake "delivered" after 5 seconds

## Requirements Coverage

### Phase 1: @lid Handling (4/4 requirements)

| Requirement | Description | Status | Evidence |
|-------------|-------------|--------|----------|
| LID-01 | Create jid.utils.ts | SATISFIED | src/ghl/jid.utils.ts (61 lines, 4 functions) |
| LID-02 | Update ghl.service.ts to use split('@')[0] | SATISFIED | ghl.service.ts:520 uses extractPhoneFromJid |
| LID-03 | Update ghl.transformer.ts to detect and log @lid | SATISFIED | Logging in ghl.service.ts:521-523 |
| LID-04 | All JID formats handled uniformly | SATISFIED | split('@')[0] handles @lid, @c.us, @g.us, @s.whatsapp.net |

### Phase 2: Database Schema (5/5 requirements)

| Requirement | Description | Status | Evidence |
|-------------|-------------|--------|----------|
| STATUS-01 | Add SentMessage model | SATISFIED | prisma/schema.prisma:49-60 |
| STATUS-02 | Add Instance relation with cascade delete | SATISFIED | ON DELETE CASCADE in migration |
| STATUS-03 | Create migration | SATISFIED | 20260113000000_add_sent_messages |
| STATUS-04 | Add createSentMessage method | SATISFIED | prisma.service.ts:158 |
| STATUS-05 | Add findSentMessageByEvolutionId | SATISFIED | prisma.service.ts:177 |

### Phase 3: Status Webhook Flow (7/7 requirements)

| Requirement | Description | Status | Evidence |
|-------------|-------------|--------|----------|
| STATUS-07 | Store mapping after Evolution send | SATISFIED | ghl.service.ts:737 createSentMessage call |
| STATUS-08 | Add MESSAGES_UPDATE to allowed events | SATISFIED | evolution-webhook.types.ts:238 |
| STATUS-09 | Add handleMessagesUpdate method | SATISFIED | ghl.service.ts:431-478 |
| STATUS-10 | Add mapEvolutionStatusToGhl helper | SATISFIED | ghl.service.ts:483-501 |
| STATUS-11 | Update GHL via real webhook data | SATISFIED | ghl.service.ts:464-477 PUT request |
| STATUS-12 | Only "sent" immediately (no fake delivered) | SATISFIED | ghl.service.ts:727, no hardcoded delivered |
| STATUS-13 | Remove setTimeout fake delivery | SATISFIED | No setTimeout in ghl.service.ts |

**Total: 16/16 requirements satisfied**

## Phase Verification Summary

| Phase | Status | Score | Verified |
|-------|--------|-------|----------|
| 01-lid-handling | PASSED | 4/4 truths | 2025-01-17 |
| 02-database-schema | PASSED | N/A (pre-existing) | 2025-01-17 |
| 03-status-webhook-flow | PASSED | 5/5 truths | 2025-01-18 |

## Cross-Phase Integration

### Wiring Matrix

| Export | From | Used By | Status |
|--------|------|---------|--------|
| extractPhoneFromJid | jid.utils.ts | ghl.service.ts, ghl.transformer.ts | CONNECTED |
| isLidJid | jid.utils.ts | ghl.service.ts | CONNECTED |
| isGroupJid | jid.utils.ts | ghl.transformer.ts | CONNECTED |
| createSentMessage | prisma.service.ts | ghl.service.ts | CONNECTED |
| findSentMessageByEvolutionId | prisma.service.ts | ghl.service.ts | CONNECTED |
| handleMessagesUpdate | ghl.service.ts | handleEvolutionWebhook router | CONNECTED |
| mapEvolutionStatusToGhl | ghl.service.ts | handleMessagesUpdate | CONNECTED |
| isMessagesUpdateData | evolution-webhook.types.ts | ghl.service.ts | CONNECTED |

**Result: 8/8 critical connections verified**

## End-to-End Flows

### Flow 1: Inbound @lid Message (COMPLETE)

```
Evolution API webhook
  → webhooks.controller.ts (POST /webhooks/evolution)
  → ghl.service.handleEvolutionWebhook
  → MESSAGES_UPSERT case
  → extractPhoneFromJid(remoteJid)  [Phase 1]
  → isLidJid check + warning log    [Phase 1]
  → upsertContact to GHL
  → sendMessageToGhlConversation
  → Message appears in GHL ✓
```

### Flow 2: Outbound Message with Mapping (COMPLETE)

```
GHL outbound webhook
  → webhooks.controller.ts (POST /webhooks/ghl)
  → ghl.service.handleGhlOutboundMessage
  → Evolution API sendMessage
  → Mark as "sent" immediately (not fake delivered)
  → createSentMessage(ghlId, evolutionId)  [Phase 2]
  → Mapping stored for status correlation ✓
```

### Flow 3: Status Update Flow (COMPLETE)

```
Evolution MESSAGES_UPDATE webhook
  → webhooks.controller.ts (POST /webhooks/evolution)
  → ghl.service.handleEvolutionWebhook
  → MESSAGES_UPDATE case             [Phase 3]
  → handleMessagesUpdate             [Phase 3]
  → findSentMessageByEvolutionId     [Phase 2]
  → mapEvolutionStatusToGhl          [Phase 3]
  → PUT /conversations/messages/{id}/status
  → GHL shows real status ✓
```

**Result: 3/3 flows verified end-to-end**

## Tech Debt (Non-Critical)

| Item | Phase | Priority | Notes |
|------|-------|----------|-------|
| cleanupOldSentMessages not scheduled | 02 | LOW | Define cron job to purge old mappings (30+ days) |

## Orphaned Exports (Non-Critical)

| Export | Location | Impact | Reason |
|--------|----------|--------|--------|
| formatJid | jid.utils.ts | LOW | Utility available for future use |
| findSentMessageByGhlId | prisma.service.ts | LOW | Reverse lookup for debugging |
| cleanupOldSentMessages | prisma.service.ts | LOW | Needs cron job post-v1 |

## Database Migration Status

| Migration | Status | Deploy Command |
|-----------|--------|----------------|
| 20260113000000_add_sent_messages | Ready | `prisma migrate deploy` |

**Note:** Migration should be run on production during deployment.

## Anti-Patterns Found

| Phase | Finding | Severity | Assessment |
|-------|---------|----------|------------|
| 01 | placeholder_ghl_contact_id in error paths | Info | Pre-existing, not in @lid path |
| 03 | None | - | Clean implementation |

## Test Alignment

| Test File | Status | Notes |
|-----------|--------|-------|
| ghl.transformer.spec.ts | ALIGNED | Tests extractPhoneFromJid and isGroupMessage |

---

## Conclusion

**v1 Milestone: PASSED**

All 16 requirements satisfied. All 3 E2E flows verified. Cross-phase integration complete.

### Operational Checklist for Deployment

- [ ] Run `prisma migrate deploy` on production
- [ ] Verify SentMessage table created
- [ ] Monitor logs for @lid warnings (new visibility)
- [ ] Consider scheduling cleanupOldSentMessages post-launch

---

*Audit completed: 2025-01-18*
*Auditor: Claude (gsd-integration-checker + orchestrator)*
