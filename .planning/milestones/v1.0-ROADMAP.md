# Milestone v1.0: Bug Fixes

**Status:** SHIPPED 2026-01-18
**Phases:** 1-3
**Total Plans:** 2 (Phase 2 pre-existing)

## Overview

This milestone delivers two critical bug fixes for the WhatsApp-to-GHL adapter: @lid identifier handling (preventing silent message loss for Android users) and real message status tracking (replacing fake delivery confirmations with actual read receipts). The fixes proceed in dependency order: @lid handling and database schema can run in parallel, then status webhook flow builds on the schema.

## Phases

### Phase 1: @lid Handling

**Goal**: Messages from Android WhatsApp users reach GHL with valid phone numbers
**Depends on**: Nothing (first phase)
**Plans**: 1 plan

Plans:

- [x] 01-01-PLAN.md - Create JID utilities and fix phone extraction

**Details:**

Requirements: LID-01, LID-02, LID-03, LID-04

Success Criteria achieved:
1. Message from Android user (@lid identifier) appears in GHL conversation
2. Contact created with valid phone number (no @lid suffix in GHL)
3. Logs show warning when @lid identifier processed
4. Reply from GHL reaches the Android user

**Key changes:**
- Created `src/ghl/jid.utils.ts` with extractPhoneFromJid, isGroupJid, isLidJid, formatJid
- Updated ghl.service.ts, ghl.transformer.ts, evolution-api.client.ts to use new utilities
- Added @lid warning logging for monitoring

### Phase 2: Database Schema

**Goal**: Message ID correlation table exists and Prisma service can read/write mappings
**Depends on**: Nothing (can run parallel with Phase 1)
**Plans**: 0 plans (pre-existing implementation discovered)

Plans:

- [x] Pre-existing: SentMessage model in schema.prisma
- [x] Pre-existing: Migration 20260113000000_add_sent_messages
- [x] Pre-existing: createSentMessage, findSentMessageByEvolutionId, findSentMessageByGhlId methods

**Details:**

Requirements: STATUS-01, STATUS-02, STATUS-03, STATUS-04, STATUS-05

Note: Phase 2 was found to be already implemented. The SentMessage model and PrismaService methods were created in a prior session. Migration exists but needs deployment via `prisma migrate deploy`.

**SentMessage table schema:**
- id (Int, auto-increment)
- ghlMessageId (String, unique index)
- evolutionMsgId (String, index)
- instanceId (Int, foreign key with cascade delete)
- contactPhone (String)
- createdAt (DateTime)

### Phase 3: Status Webhook Flow

**Goal**: GHL shows real delivered/read status based on Evolution API webhooks
**Depends on**: Phase 2
**Plans**: 1 plan (verification only - implementation pre-existing)

Plans:

- [x] 03-01-PLAN.md - Verify status webhook flow implementation

**Details:**

Requirements: STATUS-07, STATUS-08, STATUS-09, STATUS-10, STATUS-11, STATUS-12, STATUS-13

Success Criteria achieved:
1. Outbound message creates SentMessage record with Evolution ID
2. MESSAGES_UPDATE webhook updates GHL message status to delivered/read
3. Message status in GHL reflects actual delivery state (not hardcoded)
4. No false "delivered" status within 5 seconds of sending
5. Failed messages show failed status in GHL

**Key implementation:**
- `handleMessagesUpdate` method at ghl.service.ts:431-478
- `mapEvolutionStatusToGhl` helper at ghl.service.ts:483-501
- Status mapping: READ/PLAYED→"read", DELIVERED→"delivered", SENT→"sent", ERROR/FAILED→"failed"
- No setTimeout or fake status patterns

---

## Milestone Summary

**Key Decisions:**

- Use `split('@')[0]` for all JID formats (Rationale: Uniform handling without format-specific regex)
- Add SentMessage table with Evolution ID as unique index (Rationale: Fast status webhook lookup)
- Remove fake status, rely on real webhooks (Rationale: Truthful status better than false confidence)
- Created jid.utils.ts utility file (Rationale: Centralize JID handling, prevent regex drift)
- Best-effort status updates (Rationale: Status tracking shouldn't break message flow)

**Issues Resolved:**

- Android @lid messages silently dropped — now correctly extract phone numbers
- Fake "delivered" status after 5 seconds — now show real status from webhooks
- No correlation between Evolution message ID and GHL message ID — now stored in SentMessage table

**Issues Deferred:**

- Persistent LID-to-phone mapping table (like WAHA) — v2 candidate
- Failed message retry logic — v2 candidate
- Status change audit log — v2 candidate

**Technical Debt Incurred:**

- `cleanupOldSentMessages()` method defined but not scheduled — needs cron job post-v1
- Some orphaned exports (formatJid, findSentMessageByGhlId) — available for future use

---

_For current project status, see .planning/PROJECT.md_
