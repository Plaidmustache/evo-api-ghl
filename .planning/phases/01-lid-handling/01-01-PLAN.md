---
plan: 01-01
title: Create JID utilities and fix phone extraction
phase: 01
wave: 1
depends_on: []
files_modified:
  - src/ghl/jid.utils.ts
  - src/ghl/ghl.service.ts
  - src/ghl/ghl.transformer.ts
  - src/evolution/evolution-api.client.ts
autonomous: true

must_haves:
  truths:
    - "Message from Android user (@lid identifier) appears in GHL conversation"
    - "Contact created with valid phone number (no @lid suffix in GHL)"
    - "Logs show warning when @lid identifier processed"
    - "Reply from GHL reaches the Android user"
  artifacts:
    - path: "src/ghl/jid.utils.ts"
      provides: "Phone extraction utilities for all JID formats"
      exports: ["extractPhoneFromJid", "isGroupJid", "isLidJid", "formatJid"]
    - path: "src/ghl/ghl.service.ts"
      provides: "Updated phone extraction using utilities"
      contains: "extractPhoneFromJid"
    - path: "src/ghl/ghl.transformer.ts"
      provides: "Updated phone extraction and exposes methods for tests"
      contains: "extractPhoneFromJid"
  key_links:
    - from: "src/ghl/ghl.service.ts"
      to: "src/ghl/jid.utils.ts"
      via: "import extractPhoneFromJid, isLidJid"
      pattern: "import.*extractPhoneFromJid.*from.*jid\\.utils"
    - from: "src/ghl/ghl.transformer.ts"
      to: "src/ghl/jid.utils.ts"
      via: "import and re-export utilities"
      pattern: "import.*extractPhoneFromJid.*from.*jid\\.utils"
---

<objective>
Fix @lid identifier handling so Android WhatsApp users' messages reach GHL with valid phone numbers.

Purpose: Currently ~30-40% of Android users send messages with @lid JID format, which the adapter doesn't handle. These messages either fail silently or create invalid contacts in GHL. This fix ensures all JID formats are handled uniformly.

Output: Working phone extraction for all JID formats (@lid, @s.whatsapp.net, @c.us, @g.us) with logging when @lid identifiers are processed.
</objective>

<context>
@.planning/phases/01-lid-handling/01-RESEARCH.md
@src/ghl/ghl.service.ts
@src/ghl/ghl.transformer.ts
@src/ghl/ghl.transformer.spec.ts
@src/evolution/evolution-api.client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create jid.utils.ts with phone extraction utilities</name>
  <files>src/ghl/jid.utils.ts</files>
  <action>
Create new file src/ghl/jid.utils.ts with these exported functions:

1. `extractPhoneFromJid(jid: string | null | undefined): string`
   - Returns empty string if jid is falsy
   - Returns `jid.split("@")[0]` otherwise
   - Handles all formats uniformly: @lid, @s.whatsapp.net, @c.us, @g.us

2. `isGroupJid(jid: string | null | undefined): boolean`
   - Returns `jid?.endsWith("@g.us") ?? false`

3. `isLidJid(jid: string | null | undefined): boolean`
   - Returns `jid?.endsWith("@lid") ?? false`

4. `formatJid(phone: string, type: "private" | "group" = "private"): string`
   - Cleans phone with `phone.replace(/\D/g, "")`
   - Returns `${cleaned}@g.us` for group, `${cleaned}@c.us` for private

Add JSDoc comments explaining each function handles all JID formats.
  </action>
  <verify>File exists and exports 4 functions: `grep -c "export function" src/ghl/jid.utils.ts` returns 4</verify>
  <done>jid.utils.ts exists with extractPhoneFromJid, isGroupJid, isLidJid, formatJid exported</done>
</task>

<task type="auto">
  <name>Task 2: Update ghl.service.ts, ghl.transformer.ts, and evolution-api.client.ts</name>
  <files>src/ghl/ghl.service.ts, src/ghl/ghl.transformer.ts, src/evolution/evolution-api.client.ts</files>
  <action>
**ghl.service.ts:**
1. Add import at top: `import { extractPhoneFromJid, isLidJid } from "./jid.utils";`
2. Line 519: Replace `remoteJid.replace(/@s\.whatsapp\.net$/, "").replace(/@g\.us$/, "")` with `extractPhoneFromJid(remoteJid)`
3. After line 519 (after phone extraction), add @lid warning:
   ```typescript
   if (isLidJid(remoteJid)) {
     this.logger.warn(`Processing @lid identifier: ${remoteJid} -> ${phone}`);
   }
   ```
4. Line 585: Replace `msg.key.participant.replace(/@s\.whatsapp\.net$/, "")` with `extractPhoneFromJid(msg.key.participant)`

**ghl.transformer.ts:**
1. Add import at top: `import { extractPhoneFromJid as extractPhone, isGroupJid } from "./jid.utils";`
2. Add public methods to class (for existing test compatibility):
   ```typescript
   extractPhoneFromJid(jid: string): string {
     return extractPhone(jid);
   }

   isGroupMessage(jid: string): boolean {
     return isGroupJid(jid);
   }
   ```
3. Line 268: Replace `senderNumber.split("@c.us")[0]` with `extractPhone(senderNumber)`
4. Line 282: Replace `webhook.from?.replace("@c.us", "")` with `extractPhone(webhook.from)`

**evolution-api.client.ts:**
1. Line 160: Replace `phone.replace(/@[cgs]\.us$/, "")` with `phone.split("@")[0]`
   (Inline change - no import needed for this simple case)
  </action>
  <verify>
- `npm run build` succeeds with no errors
- `npm test -- --testPathPattern=ghl.transformer.spec.ts` passes (tests expect extractPhoneFromJid and isGroupMessage methods)
- `grep -r "isLidJid" src/ghl/ghl.service.ts` shows warning log added
  </verify>
  <done>
- All phone extraction uses split('@')[0] approach
- Existing tests pass (extractPhoneFromJid and isGroupMessage exposed on transformer)
- @lid identifiers log warning when processed
  </done>
</task>

</tasks>

<verification>
1. Build check: `npm run build` completes without TypeScript errors
2. Test check: `npm test` passes (existing transformer tests validate extractPhoneFromJid)
3. Lint check: `npm run lint` passes
4. Pattern verification: `grep -r "@s\.whatsapp\.net" src/` should only appear in comments/docs, not in active code
5. Pattern verification: `grep -r "split.*@" src/ghl/jid.utils.ts` confirms uniform approach
</verification>

<success_criteria>
1. All JID formats handled uniformly (@lid, @s.whatsapp.net, @c.us, @g.us)
2. No TypeScript/build errors
3. Existing tests pass
4. @lid processing logs warning
5. Phone numbers extracted correctly (no @ suffix reaches GHL)
</success_criteria>

<output>
After completion, create `.planning/phases/01-lid-handling/01-01-SUMMARY.md`
</output>
