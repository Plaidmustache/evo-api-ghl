---
plan: 03-01
title: Verify status webhook flow implementation
phase: 03
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
verification_only: true

must_haves:
  truths:
    - "Outbound message creates SentMessage record with Evolution ID"
    - "MESSAGES_UPDATE webhook updates GHL message status to delivered/read"
    - "Message status in GHL reflects actual delivery state (not hardcoded)"
    - "No false 'delivered' status within 5 seconds of sending"
    - "Failed messages show failed status in GHL"
  artifacts:
    - path: "src/ghl/ghl.service.ts"
      provides: "Message mapping storage after send"
      contains: "createSentMessage"
    - path: "src/ghl/ghl.service.ts"
      provides: "Status webhook handler"
      contains: "handleMessagesUpdate"
    - path: "src/ghl/ghl.service.ts"
      provides: "Status mapping helper"
      contains: "mapEvolutionStatusToGhl"
    - path: "src/ghl/types/evolution-webhook.types.ts"
      provides: "MESSAGES_UPDATE in allowed events"
      contains: "MESSAGES_UPDATE"
    - path: "prisma/migrations/20260113000000_add_sent_messages/migration.sql"
      provides: "Database migration for SentMessage table"
      contains: "CREATE TABLE"
  key_links:
    - from: "src/ghl/ghl.service.ts:handleGhlOutboundMessage"
      to: "prisma.createSentMessage"
      via: "message mapping storage after Evolution API send"
      pattern: "await this\\.prisma\\.createSentMessage"
    - from: "src/ghl/ghl.service.ts:handleMessagesUpdate"
      to: "prisma.findSentMessageByEvolutionId"
      via: "lookup GHL message ID from Evolution ID"
      pattern: "await this\\.prisma\\.findSentMessageByEvolutionId"
    - from: "src/ghl/ghl.service.ts:handleEvolutionWebhook"
      to: "handleMessagesUpdate"
      via: "webhook router dispatches MESSAGES_UPDATE"
      pattern: "case \"MESSAGES_UPDATE\""
---

<objective>
Verify that the status webhook flow implementation is complete and correct.

Purpose: Research discovered all Phase 3 requirements (STATUS-07 through STATUS-13) are already implemented in the codebase. This plan verifies implementation correctness and confirms production readiness rather than implementing new code.

Output: Verification report confirming all requirements are met, with any issues documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-status-webhook-flow/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify message mapping storage implementation (STATUS-07)</name>
  <files>src/ghl/ghl.service.ts, src/prisma/prisma.service.ts</files>
  <action>
    Verify that outbound messages store GHL-to-Evolution ID mappings:

    1. Confirm `handleGhlOutboundMessage` calls `prisma.createSentMessage` after Evolution API send
    2. Verify the mapping includes: ghlMessageId, evolutionMsgId, instanceId, contactPhone
    3. Confirm the condition `evolutionMsgId !== "sent"` prevents invalid mappings
    4. Verify error handling doesn't throw (best-effort storage)

    Expected location: ghl.service.ts lines 734-748

    Document findings with line numbers and code snippets.
  </action>
  <verify>
    grep -n "createSentMessage" src/ghl/ghl.service.ts shows call in handleGhlOutboundMessage.
    grep -n "evolutionMsgId !== \"sent\"" src/ghl/ghl.service.ts shows guard condition.
  </verify>
  <done>Message mapping storage verified: createSentMessage called with correct parameters after Evolution API send</done>
</task>

<task type="auto">
  <name>Task 2: Verify MESSAGES_UPDATE webhook handling (STATUS-08, STATUS-09, STATUS-10, STATUS-11)</name>
  <files>src/ghl/ghl.service.ts, src/ghl/types/evolution-webhook.types.ts</files>
  <action>
    Verify the complete status webhook processing chain:

    1. **STATUS-08**: Confirm MESSAGES_UPDATE in ALLOWED_EVOLUTION_EVENTS array
       Location: evolution-webhook.types.ts line 238

    2. **STATUS-09**: Verify handleMessagesUpdate method exists and:
       - Filters out incoming messages (fromMe: false)
       - Extracts message ID from data.keyId or data.messageId
       - Logs "No mapping found" for unknown messages (debug level)
       Location: ghl.service.ts lines 431-478

    3. **STATUS-10**: Verify mapEvolutionStatusToGhl maps all statuses:
       - READ/PLAYED -> "read"
       - DELIVERY_ACK/DELIVERED -> "delivered"
       - SERVER_ACK/SENT -> "sent"
       - PENDING -> "pending"
       - ERROR/FAILED -> "failed"
       Location: ghl.service.ts lines 483-501

    4. **STATUS-11**: Verify GHL status update uses correct endpoint:
       PUT /conversations/messages/{ghlMessageId}/status
       Location: ghl.service.ts lines 464-477

    Document all findings with line numbers.
  </action>
  <verify>
    grep -n "MESSAGES_UPDATE" src/ghl/types/evolution-webhook.types.ts shows in allowed events.
    grep -n "handleMessagesUpdate" src/ghl/ghl.service.ts shows method definition.
    grep -n "mapEvolutionStatusToGhl" src/ghl/ghl.service.ts shows all status mappings.
  </verify>
  <done>Status webhook chain verified: MESSAGES_UPDATE routed to handler, status mapped correctly, GHL updated via PUT endpoint</done>
</task>

<task type="auto">
  <name>Task 3: Verify no fake status updates remain (STATUS-12, STATUS-13)</name>
  <files>src/ghl/ghl.service.ts</files>
  <action>
    Verify all hardcoded/fake status mechanisms have been removed:

    1. **STATUS-12**: Confirm only "sent" status is set immediately after send
       - Find the status update after Evolution API send
       - Verify it uses { status: "sent" }, NOT "delivered"
       Location: ghl.service.ts lines 721-732

    2. **STATUS-13**: Confirm no setTimeout for fake delivery status
       - Search for setTimeout patterns in ghl.service.ts
       - Search for any delayed status update patterns
       - Verify no "delivered" hardcode anywhere in the send flow

    Run these searches:
    - grep -n "setTimeout" src/ghl/ghl.service.ts (should have no status-related matches)
    - grep -n "\"delivered\"" src/ghl/ghl.service.ts (should only appear in mapEvolutionStatusToGhl)

    Document findings confirming no fake status mechanisms exist.
  </action>
  <verify>
    grep -n 'status: "sent"' src/ghl/ghl.service.ts shows immediate sent status.
    grep -n 'setTimeout.*status\|delivered.*setTimeout' src/ghl/ghl.service.ts returns no matches.
  </verify>
  <done>No fake status: only "sent" set immediately, no setTimeout delays, "delivered" only from real webhooks</done>
</task>

</tasks>

<verification>
All Phase 3 requirements verified:

| Requirement | Verification |
|-------------|--------------|
| STATUS-07 | createSentMessage called after Evolution API send |
| STATUS-08 | MESSAGES_UPDATE in ALLOWED_EVOLUTION_EVENTS |
| STATUS-09 | handleMessagesUpdate method exists with correct logic |
| STATUS-10 | mapEvolutionStatusToGhl maps all Evolution statuses |
| STATUS-11 | PUT /conversations/messages/{id}/status endpoint used |
| STATUS-12 | Only "sent" status set immediately |
| STATUS-13 | No setTimeout for fake delivery |

Database migration: 20260113000000_add_sent_messages exists with correct schema.

NOTE: Migration deployment to production is an operational concern, not a code verification item. The migration exists and will be applied during normal deployment workflow.
</verification>

<success_criteria>
- All 7 requirements (STATUS-07 through STATUS-13) verified as implemented
- Code locations documented with line numbers
- No fake status mechanisms found
- SUMMARY confirms Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-status-webhook-flow/03-01-SUMMARY.md`

Update REQUIREMENTS.md to mark STATUS-07 through STATUS-13 as complete.
Update ROADMAP.md to mark Phase 3 as complete.
Update STATE.md to reflect project completion.
</output>
