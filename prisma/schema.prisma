generator client {
  provider = "prisma-client-js"
}

generator json {
  provider = "prisma-json-types-generator"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String     @id
  companyId      String?
  accessToken    String     @db.Text
  refreshToken   String     @db.Text
  tokenExpiresAt DateTime?
  instances      Instance[]
  createdAt      DateTime   @default(now())
}

enum InstanceState {
  open
  close
  connecting
}

model Instance {
  id              BigInt         @id @default(autoincrement())
  instanceName    String         @unique
  evolutionApiUrl String
  evolutionApiKey String
  stateInstance   InstanceState?
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  /// [InstanceSettings]
  settings        Json?          @default("{}") @db.Json
  name            String?
  createdAt       DateTime       @default(now())
  sentMessages    SentMessage[]

  @@index([userId])
}

// Tracks outbound messages for read receipt mapping
// Maps GHL messageId <-> Evolution/WhatsApp messageId
model SentMessage {
  id              BigInt    @id @default(autoincrement())
  ghlMessageId    String    @unique          // GHL's message ID
  evolutionMsgId  String    @db.VarChar(100) // Evolution/WhatsApp message ID
  instanceId      BigInt
  instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  contactPhone    String?   @db.VarChar(50)  // For debugging
  createdAt       DateTime  @default(now())

  @@index([evolutionMsgId])
  @@index([instanceId])
}
